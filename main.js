!function(){"use strict";class e{constructor(e){this.callback=e,this.checkValidity=this.checkValidity.bind(this)}geo(){this.promiseThroughAPI().then((e=>{this.callback(e)})).catch((()=>{this.askCoords()}))}promiseThroughAPI(){return navigator.geolocation?new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition((t=>{e({latitude:t.coords.latitude,longitude:t.coords.longitude})}),(e=>{t(e)}))})):new Promise(((e,t)=>t(new Error("No Geolocation API"))))}askCoords(){this.modal=document.createElement("div"),this.modal.classList.add("timeline_geo"),this.modal.innerHTML='\n      <form class="timeline_geo_form">\n        <div>\n          <p>К сожалению, нам не удалось определить Ваше местоположение, пожалуйста, дайте разрешение на использование геолокации, либо\n            введите координаты вручную.</p>\n          <p>Широта и долгота через запятую:</p>\n        </div>\n        <div class="timeline_geo_container">\n          <input name="geo_input" class="timeline_geo_input" placeholder="00.00000, 00.00000">\n        </div>\n        <div class="timeline_geo_controls">\n          <button type="submit">OK</button>\n          <button type="button" class="timeline_geo_close">Отмена</button>\n        </div>\n      </form>',document.body.append(this.modal),this.modal.querySelector(".timeline_geo_input").focus(),this.modal.querySelector(".timeline_geo_close").addEventListener("click",(()=>this.modal.remove())),this.modal.querySelector("form.timeline_geo_form").addEventListener("submit",this.checkValidity)}checkValidity(e){e.preventDefault();const t=this.geoInputFormat(this.modal.querySelector(".timeline_geo_input").value);t.error?this.geoShowError(this.modal.querySelector(".timeline_geo_input"),"Введите значение в формате 00.00, 00.00"):(this.callback(t),this.modal.remove())}geoInputFormat(e){const t=e.split(",").map((e=>e.match(/[+|−|-|—|-]?\d{1,3}\.\d+/)));return t[0]&&t[1]?{latitude:t[0][0],longitude:t[1][0]}:{error:"incorrect"}}geoShowError(e,t){const i=document.createElement("div");i.classList.add("timeline_geo_error"),i.innerText=t,e.closest("div").append(i),i.style.left=e.offsetLeft+e.offsetWidth/2-i.offsetWidth/2+"px",i.style.top=`${e.offsetTop+e.offsetHeight}px`,e.addEventListener("focus",(()=>i.remove()))}}new class{constructor(e){this.parentElement=e,this.formElement=this.parentElement.querySelector(".timeline_form_textarea"),this.timelineElement=this.parentElement.querySelector(".timeline_container"),this.addPost=this.addPost.bind(this)}init(){this.formElement.addEventListener("keyup",(e=>{13===e.keyCode&&this.onKeyUp()}))}onKeyUp(){if(""===this.formElement.value.trim()){const e=document.createElement("div");return e.classList.add("timeline_form_error"),e.innerText="Введите текст в поле",this.formElement.after(e),this.formElement.value="",void this.formElement.addEventListener("keyup",(()=>e.remove()))}this.geoAPI=new e(this.addPost),this.geoAPI.geo()}addPost(e){const t=document.createElement("li");t.classList.add("timeline_post");const i=document.createElement("div");i.classList.add("timeline_post_container");const o=document.createElement("div");o.classList.add("timeline_post_message"),o.innerText=this.formElement.value.trim();const n=document.createElement("div");n.classList.add("timeline_post_time");const s=new Date;n.innerText=`${s.toLocaleString("ru-RU",{year:"2-digit",month:"2-digit",day:"2-digit"})} ${s.toLocaleString("ru-RU",{minute:"2-digit",hour:"2-digit"})} `;const r=document.createElement("div");r.classList.add("timeline_post_geo"),r.innerText=`[${e.latitude}, ${e.longitude}]`,i.append(o,n),t.append(i,r),this.timelineElement.prepend(t),this.formElement.value=""}}(document.querySelector("section.timeline")).init()}();